# ltbot-server 宝塔面板部署指南

## 📋 目录
- [部署前准备](#部署前准备)
- [服务器环境要求](#服务器环境要求)
- [宝塔面板配置](#宝塔面板配置)
- [项目部署步骤](#项目部署步骤)
- [PM2进程管理配置](#pm2进程管理配置)
- [Nginx反向代理配置](#nginx反向代理配置)
- [安全配置](#安全配置)
- [常见问题处理](#常见问题处理)

---

## 🎯 部署前准备

### 1. 本地项目打包准备

在本地项目目录执行以下命令：

```bash
# 进入 ltbot-server 目录
cd packages/ltbot-server

# 安装依赖
pnpm install

# 构建项目（如果需要）
pnpm run build

# 创建部署压缩包（排除 node_modules）
# Windows PowerShell
Compress-Archive -Path .\* -DestinationPath ltbot-server.zip -Force -Exclude node_modules

# 或使用 7-Zip（推荐）
7z a -tzip ltbot-server.zip . -xr!node_modules
```

### 2. 需要上传的文件清单

```
ltbot-server/
├── index.ts              # 主入口文件
├── package.json          # 项目配置
├── package-lock.json     # 依赖锁定文件
├── tsconfig.json         # TypeScript 配置
├── types.ts              # 类型定义
├── routes/               # 路由文件夹
│   ├── agency.ts
│   └── statistics.ts
├── scripts/              # 构建脚本
│   └── build-ignore-errors.js
├── agency.json           # 数据文件
└── products.json         # 数据文件
```

**⚠️ 注意：不要上传 node_modules 文件夹！**

---

## 💻 服务器环境要求

### 系统要求
- **操作系统**：CentOS 7.x / Ubuntu 18.04+ / Debian 9+
- **内存**：最低 1GB，推荐 2GB+
- **磁盘**：至少 5GB 可用空间
- **宝塔面板**：7.x 或更高版本

### 必需软件环境
- **Node.js**：>= 18.0.0（推荐 v20.x LTS）
- **npm/pnpm**：最新版本
- **PM2**：进程管理器
- **Nginx**：反向代理

---

## 🔧 宝塔面板配置

### 第一步：安装宝塔面板（如已安装跳过）

```bash
# CentOS 安装命令
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh

# Ubuntu/Debian 安装命令
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

### 第二步：安装必要软件

登录宝塔面板后，在「软件商店」中安装：

1. **Nginx** - 1.22 或更高版本
2. **Node 版本管理器** - 用于管理多个 Node.js 版本
3. **PM2 管理器** - 用于进程守护

#### 安装指定版本的 Node.js

在宝塔面板中：
```
软件商店 → Node版本管理器 → 安装 Node.js v20.x
```

或通过命令行：
```bash
# 安装 nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 重新加载配置
source ~/.bashrc

# 安装 Node.js 20.x
nvm install 20
nvm use 20
nvm alias default 20

# 验证安装
node -v  # 应显示 v20.x.x
npm -v
```

#### 安装 pnpm（推荐）

```bash
npm install -g pnpm
pnpm -v  # 验证安装
```

#### 安装 PM2

```bash
npm install -g pm2

# 验证安装
pm2 -v

# 设置 PM2 开机自启
pm2 startup
pm2 save
```

---

## 🚀 项目部署步骤

### 步骤 1：创建项目目录

在宝塔面板或 SSH 中创建项目目录：

```bash
# 创建网站目录
mkdir -p /www/wwwroot/ltbot-server
cd /www/wwwroot/ltbot-server

# 设置目录权限
chown -R www:www /www/wwwroot/ltbot-server
chmod -R 755 /www/wwwroot/ltbot-server
```

### 步骤 2：通过宝塔面板上传项目

#### 方式一：通过宝塔文件管理器上传（推荐新手）

1. **打开文件管理**
   - 登录宝塔面板
   - 点击左侧「文件」菜单
   - 导航到 `/www/wwwroot/ltbot-server`

2. **上传项目文件**
   - 点击「上传」按钮
   - 选择本地打包好的 `ltbot-server.zip`
   - 等待上传完成

3. **解压文件**
   - 右键点击 `ltbot-server.zip`
   - 选择「解压」
   - 解压后删除 zip 文件

#### 方式二：通过宝塔 Node 项目管理上传

1. **进入 Node 项目管理**
   ```
   宝塔面板 → 网站 → Node项目 → 添加Node项目
   ```

2. **填写项目配置**（对应图片中的表单）
   ```
   项目配置：
   ├─ 项目名称: ltbot_server
   ├─ 项目目录: /www/wwwroot/ltbot-server
   ├─ 启动文件: index.ts
   ├─ 自动启动: devnpx esno index.ts
   ├─ Node版本: v22.14.0 (或你安装的版本)
   ├─ 包管理器: npm (或 pnpm)
   ├─ 运行用户: www
   ├─ 项目端口: 3000
   └─ 项目备注: ltbot_server
   ```

3. **上传文件**
   - 点击「上传项目文件」
   - 或使用文件管理器直接上传

### 步骤 3：安装项目依赖

通过 SSH 或宝塔终端执行：

```bash
# 进入项目目录
cd /www/wwwroot/ltbot-server

# 使用 pnpm 安装依赖（推荐）
pnpm install

# 或使用 npm
npm install

# 安装可能需要的全局依赖
npm install -g esno typescript
```

### 步骤 4：测试运行

```bash
# 测试运行（开发模式）
pnpm run dev

# 或
npx esno index.ts

# 如果能看到以下输出，说明成功：
# Server is running at http://localhost:3000
```

按 `Ctrl+C` 停止测试运行。

---

## 🔄 PM2进程管理配置

### 创建 PM2 配置文件

在项目根目录创建 `ecosystem.config.js`：

```bash
cd /www/wwwroot/ltbot-server
nano ecosystem.config.js
```

添加以下内容：

```javascript
module.exports = {
  apps: [
    {
      name: 'ltbot-server',                    // 应用名称
      script: './index.ts',                     // 启动文件
      interpreter: 'npx',                       // 使用 npx 作为解释器
      interpreter_args: 'esno',                 // 解释器参数
      instances: 1,                             // 实例数量
      exec_mode: 'cluster',                     // 执行模式
      watch: false,                             // 是否监听文件变化
      max_memory_restart: '500M',               // 内存超过500M自动重启
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      },
      env_development: {
        NODE_ENV: 'development',
        PORT: 3000
      },
      error_file: './logs/error.log',           // 错误日志
      out_file: './logs/out.log',               // 输出日志
      log_date_format: 'YYYY-MM-DD HH:mm:ss',   // 日志日期格式
      merge_logs: true,                         // 合并日志
      autorestart: true,                        // 自动重启
      max_restarts: 10,                         // 最大重启次数
      min_uptime: '10s',                        // 最小运行时间
      restart_delay: 4000                       // 重启延迟
    }
  ]
}
```

### 创建日志目录

```bash
mkdir -p /www/wwwroot/ltbot-server/logs
chown -R www:www /www/wwwroot/ltbot-server/logs
```

### PM2 常用命令

```bash
# 启动应用
pm2 start ecosystem.config.js

# 查看应用状态
pm2 status

# 查看应用日志
pm2 logs ltbot-server

# 查看实时日志
pm2 logs ltbot-server --lines 100

# 重启应用
pm2 restart ltbot-server

# 停止应用
pm2 stop ltbot-server

# 删除应用
pm2 delete ltbot-server

# 保存 PM2 配置（开机自启）
pm2 save

# 监控应用
pm2 monit

# 查看详细信息
pm2 show ltbot-server
```

### 在宝塔面板中管理 PM2

1. **进入 Node 项目管理**
   ```
   宝塔面板 → 网站 → Node项目 → 找到 ltbot_server
   ```

2. **操作选项**
   - ▶️ 启动：启动项目
   - ⏸️ 停止：停止项目
   - 🔄 重启：重启项目
   - 📝 日志：查看运行日志
   - ⚙️ 设置：修改项目配置

---

## 🌐 Nginx反向代理配置

### 方式一：通过宝塔面板配置

1. **创建网站**
   ```
   宝塔面板 → 网站 → 添加站点
   ```

2. **填写站点信息**
   ```
   域名: your-domain.com
   根目录: /www/wwwroot/ltbot-server
   备注: ltbot-server API
   ```

3. **配置反向代理**
   ```
   点击站点名称 → 设置 → 反向代理 → 添加反向代理
   
   代理名称: ltbot-server
   目标URL: http://127.0.0.1:3000
   发送域名: $host
   ```

4. **Nginx 配置示例**
   
   点击「配置文件」，添加以下内容：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 改为你的域名
    
    # 日志配置
    access_log /www/wwwlogs/ltbot-server-access.log;
    error_log /www/wwwlogs/ltbot-server-error.log;
    
    # 上传大小限制
    client_max_body_size 50M;
    
    # API 代理
    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
    
    # 根路径（可选）
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

5. **测试 Nginx 配置**
   ```bash
   nginx -t
   ```

6. **重载 Nginx**
   ```bash
   nginx -s reload
   ```
   
   或在宝塔面板中：
   ```
   软件商店 → Nginx → 设置 → 服务 → 重载配置
   ```

### 配置 HTTPS（推荐）

1. **在宝塔面板中申请 SSL 证书**
   ```
   网站设置 → SSL → Let's Encrypt → 申请
   ```

2. **强制 HTTPS**
   ```
   网站设置 → SSL → 强制HTTPS → 开启
   ```

---

## 🔒 安全配置

### 1. 防火墙配置

在宝塔面板中：
```
安全 → 防火墙 → 添加规则
```

**放行端口：**
- 80 (HTTP)
- 443 (HTTPS)
- 3000 (Node.js) - **仅允许内网访问**

**禁止外网直接访问 3000 端口：**
```bash
# 通过 SSH 执行
firewall-cmd --zone=public --remove-port=3000/tcp --permanent
firewall-cmd --reload
```

### 2. 目录权限设置

```bash
# 设置正确的所有者和权限
chown -R www:www /www/wwwroot/ltbot-server
chmod -R 755 /www/wwwroot/ltbot-server

# 保护敏感文件
chmod 600 /www/wwwroot/ltbot-server/package.json
chmod 600 /www/wwwroot/ltbot-server/*.json
```

### 3. 数据备份

在宝塔面板中设置定时备份：
```
计划任务 → 添加任务
任务类型: 备份目录
目录: /www/wwwroot/ltbot-server
执行周期: 每天凌晨2点
保留备份: 7天
```

### 4. 日志监控

设置日志轮转：
```bash
# 创建日志轮转配置
sudo nano /etc/logrotate.d/ltbot-server
```

添加内容：
```
/www/wwwroot/ltbot-server/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0644 www www
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}
```

---

## 🔧 环境变量配置（可选）

如果需要环境变量，创建 `.env` 文件：

```bash
cd /www/wwwroot/ltbot-server
nano .env
```

添加环境变量：
```env
NODE_ENV=production
PORT=3000
# 其他环境变量...
```

安装 dotenv：
```bash
pnpm add dotenv
```

在 `index.ts` 顶部添加：
```javascript
import 'dotenv/config'
```

---

## 🧪 部署验证

### 1. 检查端口占用

```bash
# 检查 3000 端口是否被占用
netstat -tulnp | grep 3000

# 或使用
lsof -i :3000
```

### 2. 测试 API 接口

```bash
# 内网测试
curl http://127.0.0.1:3000/api/products

# 外网测试（如果配置了域名）
curl https://your-domain.com/api/products
```

### 3. 查看应用日志

```bash
# PM2 日志
pm2 logs ltbot-server

# Nginx 访问日志
tail -f /www/wwwlogs/ltbot-server-access.log

# Nginx 错误日志
tail -f /www/wwwlogs/ltbot-server-error.log
```

---

## ❓ 常见问题处理

### 问题 1：Node 版本不兼容

**症状**：启动时报错 `Error: The engine "node" is incompatible`

**解决方案**：
```bash
# 安装正确的 Node 版本
nvm install 20
nvm use 20

# 或在宝塔面板中切换 Node 版本
```

### 问题 2：端口被占用

**症状**：`Error: listen EADDRINUSE: address already in use :::3000`

**解决方案**：
```bash
# 查找占用端口的进程
lsof -i :3000

# 杀死进程（替换 PID）
kill -9 PID

# 或修改项目端口
nano index.ts
# 将 port = 3000 改为其他端口
```

### 问题 3：权限错误

**症状**：`EACCES: permission denied`

**解决方案**：
```bash
# 修改目录所有者
chown -R www:www /www/wwwroot/ltbot-server

# 修改目录权限
chmod -R 755 /www/wwwroot/ltbot-server
```

### 问题 4：依赖安装失败

**症状**：`npm install` 报错

**解决方案**：
```bash
# 清除缓存
npm cache clean --force
# 或
pnpm store prune

# 删除 node_modules 重新安装
rm -rf node_modules package-lock.json
pnpm install
```

### 问题 5：PM2 自动重启

**症状**：应用不断重启

**解决方案**：
```bash
# 查看错误日志
pm2 logs ltbot-server --err

# 检查内存使用
pm2 monit

# 增加内存限制
pm2 stop ltbot-server
# 修改 ecosystem.config.js 中的 max_memory_restart
pm2 start ecosystem.config.js
```

### 问题 6：502 Bad Gateway

**症状**：访问域名返回 502 错误

**解决方案**：
```bash
# 检查 Node 应用是否运行
pm2 status

# 检查端口是否监听
netstat -tulnp | grep 3000

# 检查 Nginx 配置
nginx -t

# 查看 Nginx 错误日志
tail -f /www/wwwlogs/ltbot-server-error.log
```

### 问题 7：CORS 跨域问题

**症状**：前端请求被 CORS 阻止

**解决方案**：

在 `index.ts` 中配置 CORS：
```javascript
import cors from 'cors'

app.use(cors({
  origin: 'https://your-frontend-domain.com',
  credentials: true
}))
```

---

## 📊 性能优化建议

### 1. 启用 Gzip 压缩

在 Nginx 配置中添加：
```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types application/json;
```

### 2. 设置缓存

```nginx
location /api/products {
    proxy_pass http://127.0.0.1:3000;
    proxy_cache_valid 200 5m;
    add_header X-Cache-Status $upstream_cache_status;
}
```

### 3. 限流配置

```nginx
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

location /api {
    limit_req zone=api burst=20 nodelay;
    proxy_pass http://127.0.0.1:3000;
}
```

---

## 📚 相关资源

- [宝塔官方文档](https://www.bt.cn/bbs/)
- [PM2 官方文档](https://pm2.keymetrics.io/)
- [Nginx 官方文档](https://nginx.org/en/docs/)
- [Node.js 官方文档](https://nodejs.org/docs/)

---

## ✅ 部署检查清单

部署完成后，请检查以下项目：

- [ ] Node.js 版本 >= 18.0.0
- [ ] 项目依赖安装完成
- [ ] PM2 进程正常运行
- [ ] Nginx 反向代理配置正确
- [ ] 防火墙规则配置合理
- [ ] SSL 证书配置成功（如需要）
- [ ] API 接口可以正常访问
- [ ] 日志文件正常写入
- [ ] 自动备份任务已设置
- [ ] PM2 开机自启已配置

---

**部署完成！** 🎉

如有问题，请查看日志或联系技术支持。

