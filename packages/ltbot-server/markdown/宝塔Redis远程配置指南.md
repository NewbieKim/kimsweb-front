# 宝塔面板 Redis 远程数据库配置完整指南

## 📋 目录
1. [在宝塔面板安装 Redis](#1-在宝塔面板安装-redis)
2. [配置 Redis 远程访问](#2-配置-redis-远程访问)
3. [设置 Redis 密码（必须）](#3-设置-redis-密码必须)
4. [开放服务器防火墙端口](#4-开放服务器防火墙端口)
5. [本地连接测试](#5-本地连接测试)
6. [项目代码配置](#6-项目代码配置)
7. [安全加固建议](#7-安全加固建议)
8. [常见问题排查](#8-常见问题排查)

---

## 1. 在宝塔面板安装 Redis

### 1.1 登录宝塔面板
访问：`http://你的服务器IP:8888`

### 1.2 安装 Redis
1. 点击左侧菜单 **"软件商店"**
2. 搜索 **"Redis"**
3. 找到 **"Redis 7.x"** 或最新版本
4. 点击 **"安装"**
5. 等待安装完成（约 1-3 分钟）

### 1.3 验证安装
安装完成后，在 **"软件商店"** → **"已安装"** 中可以看到 Redis，状态应为**运行中**。

---

## 2. 配置 Redis 远程访问

### 2.1 打开 Redis 配置文件
1. 在 **"软件商店"** → **"已安装"** 中找到 Redis
2. 点击 **"设置"** 按钮
3. 点击 **"配置文件"** 选项卡

### 2.2 修改配置项

找到以下配置项并修改：

#### ① 允许远程访问（关键）
```conf
# 找到这一行（默认只监听本地）
bind 127.0.0.1 ::1

# 修改为（允许所有 IP 访问）
bind 0.0.0.0
```

#### ② 关闭保护模式
```conf
# 找到这一行
protected-mode yes

# 修改为
protected-mode no
```

#### ③ 设置最大内存（可选，推荐）
```conf
# 在文件末尾添加（限制 Redis 最大使用 512MB 内存）
maxmemory 512mb
maxmemory-policy allkeys-lru
```

### 2.3 保存并重启
1. 点击 **"保存"** 按钮
2. 点击 **"服务"** 选项卡
3. 点击 **"重载配置"** 或 **"重启"**

---

## 3. 设置 Redis 密码（必须）

⚠️ **安全警告**：允许远程访问后，**必须设置强密码**，否则会被黑客攻击挖矿！

### 3.1 在配置文件中设置密码
1. 继续在 Redis **"配置文件"** 中找到：
```conf
# requirepass foobared
```

2. 取消注释并修改为强密码：
```conf
requirepass YourStrongPassword123!@#
```

**密码建议**：至少 16 位，包含大小写字母、数字和特殊字符。

### 3.2 重启 Redis
保存配置后，重启 Redis 服务。

---

## 4. 开放服务器防火墙端口

### 4.1 宝塔面板放行端口
1. 点击左侧菜单 **"安全"**
2. 找到 **"防火墙"** 区域
3. 点击 **"添加规则"**
4. 填写以下信息：
   ```
   名称：Redis
   端口：6379
   策略：放行
   协议：TCP
   备注：Redis 数据库
   ```
5. 点击 **"确定"**

### 4.2 云服务器安全组配置

如果你使用的是**阿里云/腾讯云/AWS**等云服务器，还需要在云控制台配置安全组：

#### 阿里云 ECS
1. 登录阿里云控制台
2. 进入 **ECS 实例** → 选择你的服务器
3. 点击 **"安全组"** → **"配置规则"**
4. 点击 **"添加安全组规则"**
5. 填写：
   ```
   规则方向：入方向
   授权策略：允许
   协议类型：TCP
   端口范围：6379/6379
   授权对象：0.0.0.0/0（所有IP）或你的固定IP
   描述：Redis
   ```
6. 点击 **"确定"**

#### 腾讯云 CVM
1. 登录腾讯云控制台
2. 进入 **云服务器** → **安全组**
3. 点击 **"修改规则"** → **"添加规则"**
4. 填写：
   ```
   类型：自定义
   来源：0.0.0.0/0
   协议端口：TCP:6379
   策略：允许
   ```

---

## 5. 本地连接测试

### 5.1 使用 redis-cli 测试（命令行）

在你的**本地电脑**（Windows）上测试：

```bash
# 如果已安装 redis-cli
redis-cli -h 你的服务器IP -p 6379 -a YourStrongPassword123!@#

# 成功连接后，测试
ping
# 应该返回：PONG

# 设置测试数据
set test "hello from ltbot"

# 获取数据
get test
```

### 5.2 使用 VS Code 插件测试（图形化）

**推荐插件**：`Redis` by `Dunn`

1. 在 VS Code 中安装插件
2. 点击插件图标，点击 **"+"** 添加连接
3. 填写信息：
   ```
   服务器地址：你的服务器IP
   数据库端口：6379
   数据库密码：YourStrongPassword123!@#
   管理员密码：（留空，或填写 Redis 密码）
   ```
4. 点击 **"确定"**，看到连接成功即可

**对照截图填写**：
- **服务器地址**：填写你的服务器公网 IP（如 `119.91.49.126`）
- **数据库端口**：`6379`
- **管理员密码**：填写你在配置文件中设置的 `requirepass` 密码

---

## 6. 项目代码配置

### 6.1 修改 `.env` 文件（推荐）

在 `ltbot-server` 根目录创建 `.env` 文件：

```env
# Redis 连接配置
REDIS_URL=redis://:YourStrongPassword123!@#@你的服务器IP:6379

# 示例（如果服务器IP是 119.91.49.126）
# REDIS_URL=redis://:YourStrongPassword123!@#@119.91.49.126:6379
```

**格式说明**：`redis://[:密码]@主机:端口`

### 6.2 代码已支持环境变量

`packages/ltbot-server/db/redis.ts` 已配置：
```typescript
const redis = createClient({
  url: process.env.REDIS_URL || 'redis://127.0.0.1:6379'
})
```

### 6.3 启动服务测试

```bash
cd d:\kimsweb\kimsweb-front
pnpm -F ltbot-server dev
```

如果看到：
```
Redis Client Connected
✅ Redis OM Index created
```
说明连接成功！

---

## 7. 安全加固建议

### 7.1 限制访问 IP（强烈推荐）

如果你的本地 IP 是固定的，建议只允许特定 IP 访问：

#### 方式一：修改 `bind` 配置
```conf
# 只允许本地和你的办公室 IP
bind 127.0.0.1 你的公网IP
```

#### 方式二：使用防火墙规则
在宝塔面板的防火墙中：
- 删除 `0.0.0.0/0`（所有IP）规则
- 添加你的固定公网 IP，如 `123.45.67.89/32`

### 7.2 修改默认端口（可选）

将 Redis 端口从 `6379` 改为非常规端口，如 `16379`：

```conf
# Redis 配置文件
port 16379
```

**记得同步修改**：
- 宝塔防火墙规则
- 云安全组规则
- 项目中的 `REDIS_URL`

### 7.3 启用 SSL/TLS（生产环境推荐）

Redis 6.0+ 支持 TLS 加密传输，可防止中间人攻击。配置较复杂，适合有经验的运维。

### 7.4 定期备份数据

在宝塔面板 Redis 设置中：
1. 点击 **"性能调整"** 选项卡
2. 开启 **RDB 持久化**（快照备份）
3. 配置自动备份策略

---

## 8. 常见问题排查

### 问题 1：连接超时 `ECONNREFUSED` 或 `ETIMEDOUT`

**原因**：防火墙未开放或 Redis 未监听外网

**解决**：
1. 检查宝塔防火墙是否放行了 `6379` 端口
2. 检查云安全组是否配置正确
3. 确认 Redis 配置 `bind 0.0.0.0`
4. 确认 Redis 服务正在运行（宝塔面板查看状态）

### 问题 2：连接成功但认证失败 `NOAUTH`

**原因**：密码错误或未提供密码

**解决**：
- 检查 `.env` 中的 `REDIS_URL` 是否包含 `:密码@`
- 确认密码与 Redis 配置文件中的 `requirepass` 一致
- 密码中如果有特殊字符，需要 URL 编码（如 `@` → `%40`）

### 问题 3：连接后无法创建索引 `FT.CREATE` 失败

**原因**：普通 Redis 不支持 RediSearch 模块

**解决方案**：
**方式一**：使用 Docker 安装 Redis Stack（推荐）
```bash
# 在服务器上执行
docker run -d --name redis-stack \
  -p 6379:6379 \
  -v /data/redis:/data \
  redis/redis-stack:latest \
  --requirepass YourStrongPassword123!@#
```

**方式二**：禁用全文搜索功能
修改 `packages/ltbot-server/db/redis.ts`，注释掉索引创建：
```typescript
// await articleRepository.createIndex()
```

### 问题 4：服务器被黑客攻击挖矿

**症状**：CPU 占用 100%，出现 `dbgr`、`bioset` 等可疑进程

**原因**：Redis 未设置密码或密码过弱

**紧急处理**：
1. 立即修改 Redis 密码为强密码
2. 修改 `bind` 为 `127.0.0.1`（仅本地访问）
3. 重启服务器
4. 检查并清除挖矿程序：
   ```bash
   ps aux | grep redis
   kill -9 挖矿进程PID
   ```

---

## 📊 配置对照表

| 配置项 | 本地开发 | 生产环境 |
|--------|---------|---------|
| **bind** | `127.0.0.1` | `0.0.0.0` 或 特定IP |
| **protected-mode** | `yes` | `no` |
| **requirepass** | 留空 | **必须设置强密码** |
| **port** | `6379` | 建议改为非常规端口 |
| **防火墙** | 不需要 | 必须配置 |
| **maxmemory** | 不限制 | 建议 512MB-2GB |

---

## 🎯 快速配置检查清单

部署前请确认：

- [ ] Redis 已在宝塔面板安装并运行
- [ ] 配置文件中 `bind 0.0.0.0`
- [ ] 配置文件中 `protected-mode no`
- [ ] 配置文件中设置了强密码 `requirepass`
- [ ] 宝塔防火墙放行了 `6379` 端口
- [ ] 云安全组放行了 `6379` 端口
- [ ] 本地可以通过 `redis-cli` 或 VS Code 插件连接
- [ ] 项目 `.env` 文件配置了正确的 `REDIS_URL`
- [ ] 启动 `ltbot-server` 看到 "Redis Client Connected"

---

## 📞 技术支持

如果仍有问题：
1. 检查服务器日志：`/www/server/redis/redis.log`
2. 检查宝塔面板 Redis 运行状态
3. 使用 `telnet 服务器IP 6379` 测试端口是否通畅

---

*文档版本：v1.0*  
*最后更新：2025-01-27*  
*适用于：宝塔面板 7.x/8.x + Redis 6.x/7.x*

