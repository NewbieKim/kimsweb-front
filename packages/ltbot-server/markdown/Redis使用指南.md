# Redis OM 使用指南 (ltbot-server)

本文档详细介绍了如何在 `ltbot-server` 中使用 `redis-om` 进行数据存储和检索。我们通过引入 Redis，提升了系统的读写性能，并支持了全文搜索功能。

## 1. 环境准备

### 1.1 依赖安装
项目已经集成了相关依赖，如果需要重新安装：
```bash
pnpm add redis-om redis
```

### 1.2 启动 Redis
确保本地或服务器已启动 Redis 服务（默认端口 6379）。
```bash
# Docker 启动示例
docker run -d -p 6379:6379 redis/redis-stack:latest
```
> **推荐使用 `redis/redis-stack`**，因为它内置了 RedisJSON 和 RediSearch 模块，这是 `redis-om` 高级搜索功能所依赖的。

### 1.3 环境变量
默认连接 `redis://localhost:6379`。如需修改，请设置环境变量：
```env
REDIS_URL=redis://:password@host:port
```

## 2. 核心概念

我们使用 `redis-om` (Object Mapping) 来简化 Redis 操作，它主要包含三个核心概念：

1.  **Client**: Redis 连接客户端。
2.  **Schema**: 定义数据的结构（字段名、类型、是否索引）。
3.  **Repository**: 提供 CRUD 和搜索 API 的仓库。

代码位置：`packages/ltbot-server/db/redis.ts`

## 3. 数据模型 (Article)

文章模型定义如下：

| 字段 | 类型 | 说明 | 索引 |
| :--- | :--- | :--- | :--- |
| `title` | string | 文章标题 | ✅ (全文搜索) |
| `content` | string | 文章内容 | ❌ |
| `summary` | string | 摘要 | ❌ |
| `author` | string | 作者 | ❌ |
| `category` | string | 分类 | ❌ |
| `tags` | string[] | 标签数组 | ❌ |
| `views` | number | 阅读量 | ✅ (可排序) |
| `status` | string | 状态 | ❌ |
| `createdAt` | date | 创建时间 | ✅ (可排序) |
| `updatedAt` | date | 更新时间 | ✅ (可排序) |

## 4. API 接口说明

所有接口前缀为 `/api/articles`。

### 4.1 创建文章
- **URL**: `POST /api/articles`
- **Body**:
  ```json
  {
    "title": "Redis OM 实战",
    "content": "Redis OM 是一个很棒的库...",
    "author": "NewbieKim",
    "category": "Tech",
    "tags": ["Redis", "Node.js"]
  }
  ```

### 4.2 获取列表 (分页)
- **URL**: `GET /api/articles?page=1&pageSize=10`
- **说明**: 返回文章列表和分页信息。

### 4.3 全文搜索
- **URL**: `GET /api/articles/search?q=关键词`
- **说明**: 在 `title` 和 `content` 中进行全文检索（需要 Redis Stack 支持 RediSearch）。

### 4.4 获取详情
- **URL**: `GET /api/articles/:id`
- **说明**: 获取单篇文章详情，同时 `views` 字段会自动 +1。

### 4.5 更新文章
- **URL**: `PUT /api/articles/:id`
- **Body**: (可选字段)
  ```json
  {
    "title": "更新后的标题",
    "status": "draft"
  }
  ```

### 4.6 删除文章
- **URL**: `DELETE /api/articles/:id`

## 5. 常用代码示例

### 查询所有数据
```typescript
const articles = await articleRepository.search().return.all();
```

### 按条件查询
```typescript
// 查询分类为 'Tech' 的文章
const techArticles = await articleRepository.search()
  .where('category').equals('Tech')
  .return.all();
```

### 排序
```typescript
// 按创建时间倒序
const latest = await articleRepository.search()
  .sortDescending('createdAt')
  .return.page(0, 10);
```

## 6. 运维与注意事项

1.  **索引重建**: 每次服务启动时，会调用 `articleRepository.createIndex()`。如果修改了 Schema 结构，建议手动清理旧的索引或数据。
2.  **Redis 持久化**: 确保 Redis 开启了 RDB 或 AOF，防止重启丢失数据。
3.  **错误处理**: 所有的 Repository 操作都是异步的，务必使用 `await` 并包裹在 `try-catch` 中。

---
*Generated by KimsWeb Engineering Team*

