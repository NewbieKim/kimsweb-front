# LTBot Next.js 项目开发规范

## 项目概述
- **项目名称**: AI睡眠空间 (LTBot Next.js)
- **项目类型**: AI 驱动的儿童故事与音乐创作平台
- **当前版本**: v0.2.0
- **生产域名**: http://space.ltbot.top
- **开发端口**: 3000
- **生产端口**: 3100

## 技术栈

### 前端
- Next.js 16.0.5 (App Router)
- React 18
- TypeScript 5.x
- Tailwind CSS 3.x
- React Hooks (状态管理)

### 后端
- Node.js 22.14.0
- Next.js API Routes
- Prisma 5.x (ORM)
- SQLite (开发) / PostgreSQL (生产可选)

### 第三方服务
- Clerk (用户认证)
- DeepSeek API (AI 故事生成)

### 部署
- Docker + Docker Compose
- Nginx (反向代理)
- 宝塔面板 (服务器管理)

---

## 代码规范

### TypeScript 规范
1. **强制使用 TypeScript**: 所有新代码必须使用 TypeScript，不允许使用 `.js` / `.jsx` 文件
2. **类型定义**: 
   - 避免使用 `any` 类型，必须明确指定类型
   - 使用 `interface` 定义对象类型，使用 `type` 定义联合类型或复杂类型
   - API 响应必须定义明确的类型
3. **空值处理**: 使用可选链 `?.` 和空值合并 `??` 操作符
4. **类型导入**: 使用 `import type` 导入类型定义

```typescript
// ✅ 正确示例
import type { User } from '@prisma/client'

interface StoryFormData {
  ageGroup: string
  themeType: 'CLASSIC' | 'CUSTOM'
  characterSetting: string
  wordCountLimit: string
}

// ❌ 错误示例
const data: any = await fetchData() // 不要使用 any
```

### 命名规范
1. **组件命名**: PascalCase（如 `CreateStory.tsx`, `StoryCard.tsx`）
2. **工具函数**: camelCase（如 `generatePrompt`, `validateForm`）
3. **常量**: UPPER_SNAKE_CASE（如 `API_BASE_URL`, `MAX_RETRY_COUNT`）
4. **私有属性**: 以下划线开头（如 `_privateMethod`）
5. **接口命名**: 以 `I` 或描述性名称开头（如 `IStoryProps` 或 `StoryCardProps`）
6. **类型别名**: PascalCase，通常以 `Type` 结尾（如 `ApiResponseType`）

### 文件组织
1. **路由文件**: 使用 Next.js App Router 规范（`page.tsx`, `layout.tsx`, `route.ts`）
2. **组件文件**: 一个文件只包含一个主要组件
3. **工具函数**: 分类放在 `lib/` 目录下
4. **自定义 Hooks**: 以 `use` 开头，放在 `hooks/` 目录
5. **常量定义**: 放在 `constants/` 目录

### 代码结构
1. **导入顺序**:
   ```typescript
   // 1. React 相关
   import { useState, useEffect } from 'react'
   
   // 2. Next.js 相关
   import { useRouter } from 'next/navigation'
   import Image from 'next/image'
   
   // 3. 第三方库
   import { useUser } from '@clerk/nextjs'
   import { toast } from 'react-toastify'
   
   // 4. 项目内部模块
   import { prisma } from '@/lib/prisma'
   import { successResponse } from '@/lib/response'
   
   // 5. 类型定义
   import type { Story } from '@prisma/client'
   ```

2. **组件结构**:
   ```typescript
   // 1. 类型定义
   interface ComponentProps {}
   
   // 2. 组件定义
   export default function Component({ props }: ComponentProps) {
     // 3. Hooks
     const router = useRouter()
     const [state, setState] = useState()
     
     // 4. 事件处理函数
     const handleClick = () => {}
     
     // 5. 副作用
     useEffect(() => {}, [])
     
     // 6. 渲染
     return <div></div>
   }
   ```

---

## API 开发规范

### 统一响应格式
**必须使用** `lib/response.ts` 中的工具函数，不允许直接使用 `NextResponse.json()`

```typescript
import {
  successResponse,      // 成功响应 (200)
  createdResponse,      // 创建成功 (201)
  errorResponse,        // 服务器错误 (500)
  badRequestResponse,   // 参数错误 (400)
  unauthorizedResponse, // 未授权 (401)
  forbiddenResponse,    // 禁止访问 (403)
  notFoundResponse,     // 未找到 (404)
} from '@/lib/response'

// ✅ 正确示例
export async function GET() {
  try {
    const data = await prisma.user.findMany()
    return successResponse(data, '获取成功')
  } catch (error) {
    return errorResponse('获取失败', 500, error)
  }
}

// ❌ 错误示例
return NextResponse.json({ success: true, data }) // 不要直接使用
```

### 参数验证
1. **必填字段验证**: 所有必填参数必须验证
2. **类型验证**: 验证参数类型是否正确
3. **格式验证**: 验证邮箱、手机号等格式
4. **业务验证**: 验证业务逻辑（如积分是否充足）

```typescript
// ✅ 正确示例
export async function POST(request: Request) {
  const body = await request.json()
  
  // 验证必填字段
  if (!body.userId) {
    return badRequestResponse('用户ID为必填项')
  }
  
  // 验证类型
  if (!body.amount || body.amount <= 0) {
    return badRequestResponse('金额必须大于0')
  }
  
  // 验证格式
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
  if (body.email && !emailRegex.test(body.email)) {
    return badRequestResponse('邮箱格式不正确')
  }
  
  // 业务验证
  const userScore = await prisma.userScore.findUnique({ where: { userId } })
  if (userScore.balance < body.amount) {
    return badRequestResponse('积分不足')
  }
}
```

### 错误处理
1. **必须使用 try-catch**: 所有 API 接口必须有错误处理
2. **详细日志**: 使用 `console.error` 记录详细错误信息
3. **Prisma 错误**: 特殊处理 Prisma 的错误代码

```typescript
try {
  // API 逻辑
} catch (error: any) {
  console.error('详细错误信息:', error)
  
  // Prisma 唯一约束错误
  if (error.code === 'P2002') {
    return badRequestResponse('该记录已存在')
  }
  
  // Prisma 外键约束错误
  if (error.code === 'P2003') {
    return badRequestResponse('关联的记录不存在')
  }
  
  return errorResponse('操作失败', 500, error)
}
```

### RESTful API 规范
1. **路由命名**: 使用小写字母和连字符（如 `/api/user-scores`）
2. **HTTP 方法**:
   - GET: 查询数据
   - POST: 创建数据
   - PUT/PATCH: 更新数据
   - DELETE: 删除数据
3. **状态码**:
   - 200: 成功
   - 201: 创建成功
   - 400: 参数错误
   - 401: 未授权
   - 403: 禁止访问
   - 404: 未找到
   - 500: 服务器错误

---

## 数据库规范（Prisma）

### 数据库操作
1. **使用 Prisma Client**: 统一使用 `@/lib/prisma` 导出的 client
2. **事务处理**: 涉及多步骤操作必须使用事务
3. **错误处理**: 捕获并处理 Prisma 特定错误

```typescript
import { prisma } from '@/lib/prisma'

// ✅ 使用事务
const result = await prisma.$transaction(async (tx) => {
  const userScore = await tx.userScore.findUnique({ where: { userId } })
  
  if (userScore.balance < amount) {
    throw new Error('积分不足')
  }
  
  const updatedScore = await tx.userScore.update({
    where: { userId },
    data: { balance: userScore.balance - amount }
  })
  
  const transaction = await tx.scoreTransaction.create({
    data: {
      userId,
      amount: -amount,
      balanceBefore: userScore.balance,
      balanceAfter: updatedScore.balance
    }
  })
  
  return { userScore: updatedScore, transaction }
})
```

### 数据库设计规范
1. **金额字段**: 禁止使用 FLOAT/DOUBLE，必须用 DECIMAL 或 Int（存储分）
2. **时间字段**: 使用 `DateTime` 类型，自动添加 `@default(now())` 和 `@updatedAt`
3. **索引**: 常用查询字段必须添加索引 `@@index([fieldName])`
4. **扩展字段**: 使用 `extData` 字段存储 JSON 格式的扩展数据
5. **关联关系**: 明确定义外键关联和级联删除规则

### 迁移规范
1. **命名**: 使用描述性名称（如 `add_story_music_score_models`）
2. **测试**: 迁移前在开发环境充分测试
3. **回滚**: 准备好回滚方案
4. **生产环境**: 使用 `prisma migrate deploy` 而非 `migrate dev`

---

## 样式规范（Tailwind CSS）

### 响应式设计
1. **移动优先**: 始终从最小屏幕开始设计，然后逐步增强
2. **断点使用**:
   - xs: 375px (小手机)
   - sm: 640px (手机横屏)
   - md: 768px (平板竖屏)
   - lg: 1024px (平板横屏/小笔记本)
   - xl: 1280px (桌面)
   - 2xl: 1536px (大屏)

```jsx
// ✅ 正确示例（移动优先）
<div className="p-4 md:p-6 lg:p-8">
  <h1 className="text-2xl md:text-3xl lg:text-4xl">标题</h1>
</div>

// ❌ 错误示例（从桌面开始）
<div className="p-8 md:p-6 sm:p-4">
```

### 颜色系统
使用项目定义的颜色变量：
- **Primary (紫色系)**: 主按钮、品牌色 (`bg-primary-500`, `text-primary-600`)
- **Secondary (粉色系)**: 次要元素、装饰 (`bg-secondary-500`, `border-secondary-300`)
- **Accent (蓝色系)**: 链接、提示 (`bg-accent-500`, `text-accent-600`)

### 预设组件类
优先使用预设的组件类：
- `btn-primary`: 主按钮
- `btn-secondary`: 次要按钮
- `card`: 卡片容器
- `input`: 输入框
- `text-gradient-primary`: 紫粉渐变文字
- `bg-gradient-soft`: 柔和渐变背景

```jsx
// ✅ 正确示例
<button className="btn-primary">创作故事</button>

// ❌ 错误示例（重复样式）
<button className="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full">
  创作故事
</button>
```

### 样式最佳实践
1. **避免内联样式**: 优先使用 Tailwind 类名
2. **提取重复样式**: 将常用样式组合提取为组件类或组件
3. **语义化类名**: 使用有意义的类名组合
4. **性能优化**: 避免过多的类名，考虑使用 `@apply` 或组件封装

---

## 安全规范

### API 安全
1. **身份验证**: 
   - 使用 Clerk 进行用户认证
   - 敏感操作必须验证用户身份
   - 使用 middleware 保护路由

2. **数据验证**:
   - 所有用户输入必须验证
   - 使用白名单验证，而非黑名单
   - 防止 SQL 注入（Prisma 已提供保护）
   - 防止 XSS 攻击（输入验证 + 输出转义）

3. **敏感信息**:
   - API 密钥必须存储在环境变量中
   - 不要在前端代码中暴露敏感信息
   - 不要将 `.env.*` 文件提交到 Git

4. **接口限流**: 
   - 实施 API 访问频率限制（计划中）
   - 防止恶意刷接口

### 数据库安全
1. **禁止使用非主键或唯一索引作为 WHERE 条件进行 UPDATE/DELETE**，预防数据库死锁
2. **事务和分布式锁不能出现在同一个方法里面**
3. **循环中禁止调用 RPC 或数据库查询**
4. **禁止超过 4 张以上的表关联查询**

### 代码安全
1. **禁止吞掉异常**: 必须正确处理或记录异常
2. **禁止使用 `new Thread()` 创建线程**: 使用线程池
3. **检查循环引用**: 嵌套引用的对象（包括 RPC 调用）
4. **日志安全**: 禁止在日志中打印敏感信息，使用 `JSON.toJSONString` 时注意脱敏

---

## 性能优化建议

### 前端优化
1. **图片优化**: 
   - 使用 Next.js `Image` 组件
   - 设置正确的 `sizes` 属性
   - 使用懒加载

2. **代码分割**:
   - 使用动态导入 `dynamic()` 加载大型组件
   - 避免在首屏加载不必要的代码

3. **缓存策略**:
   - 合理使用 `revalidate` 配置
   - 静态资源使用长期缓存

### 后端优化
1. **数据库查询**:
   - 使用索引优化查询
   - 避免 N+1 查询问题
   - 使用 `select` 只查询需要的字段
   - 大量数据使用分页

2. **异步处理**:
   - 耗时操作（如 AI 生成）使用异步处理
   - 避免阻塞主线程

3. **缓存**:
   - 计划引入 Redis 缓存
   - 缓存频繁访问的数据

### 特殊注意
1. **禁止一次性加载大量数据**，可能导致 OOM
2. **禁止全量查出再导出**，使用流式处理或分批处理
3. **金额计算 divide 操作需要指定 scale 及 roundingMode 参数**

---

## Git 提交规范

### Commit Message 格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

### Type 类型
- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档更新
- `style`: 代码格式调整（不影响功能）
- `refactor`: 重构（既不是新功能也不是 Bug 修复）
- `perf`: 性能优化
- `test`: 测试相关
- `build`: 构建系统或外部依赖变更
- `ci`: CI 配置变更
- `chore`: 其他不修改 src 或 test 的变更
- `revert`: 回退之前的 commit

### 示例
```bash
# 功能开发
feat(story): 添加故事收藏功能

# Bug 修复
fix(score): 修复积分扣除重复问题

# 文档更新
docs: 更新 API 接口文档

# 样式调整
style(mobile): 优化移动端布局

# 重构
refactor(api): 重构故事生成逻辑

# 性能优化
perf(query): 优化故事列表查询性能
```

### Git 工作流
1. **分支命名**: 
   - 功能分支: `feature/功能名称`
   - 修复分支: `fix/问题描述`
   - 热修复: `hotfix/问题描述`

2. **提交前检查**:
   - 代码已通过 Lint 检查
   - 已在本地测试通过
   - 已更新相关文档
   - Commit message 符合规范

3. **禁止操作**:
   - ❌ 不要更新 git config
   - ❌ 不要执行 `git push --force` 到 main/master
   - ❌ 不要跳过 hooks（`--no-verify`）
   - ❌ 不要在未经要求时提交代码（commit）

---

## 常用命令

### 开发命令
```bash
pnpm dev              # 启动开发服务器
pnpm build            # 构建生产版本
pnpm start            # 启动生产服务器
pnpm lint             # 代码检查
```

### 数据库命令
```bash
pnpm prisma migrate dev --name <name>  # 创建迁移
pnpm prisma migrate deploy             # 应用迁移（生产）
pnpm prisma migrate reset              # 重置数据库
pnpm prisma studio                     # 打开数据库可视化工具
pnpm prisma generate                   # 生成 Prisma Client
```

### Docker 命令
```bash
docker-compose build       # 构建镜像
docker-compose up -d       # 启动容器
docker-compose down        # 停止容器
docker-compose logs -f     # 查看日志
docker-compose restart     # 重启服务
```

---

## 项目结构

### 目录说明
```
src/
├── app/                    # Next.js App Router
│   ├── (auth)/            # 认证相关页面（路由组）
│   ├── api/               # API 路由
│   ├── components/        # 全局组件
│   ├── create-story/      # 故事创作页面
│   ├── to-explore-story/  # 故事探索页面
│   ├── create-music/      # 音乐创作页面（开发中）
│   ├── to-music-square/   # 音乐广场（开发中）
│   ├── to-view-mine/      # 个人中心
│   ├── layout.tsx         # 根布局
│   ├── globals.css        # 全局样式
│   └── page.tsx           # 首页
├── hooks/                 # 自定义 Hooks
├── lib/                   # 工具库
│   ├── prisma.ts         # Prisma Client
│   ├── response.ts       # API 响应工具
│   └── request.ts        # HTTP 请求工具
├── constants/            # 常量定义
└── middleware.ts         # 中间件
```

---

## 特殊注意事项

### 异步故事生成
1. 故事生成使用异步处理，不要阻塞用户操作
2. 生成状态存储在 `extData` 字段中
3. 前端使用轮询或 SSE（计划中）获取生成状态
4. 生成失败需要记录详细错误信息

### 移动端适配
1. 使用 `useDevice` Hook 检测设备类型
2. 移动端需要考虑 BottomNav 的高度（60px）
3. 页面底部添加适当的 padding（pb-[80px] ~ pb-[200px]）
4. 服务端组件使用 PageWrapper 包装

### Clerk 用户认证
1. 用户 ID 使用 Clerk 的 userId（格式：`user_xxxxx`）
2. 用户信息通过 Webhook 或手动同步到数据库
3. 使用 middleware 保护需要登录的路由
4. 使用 `useUser()` Hook 获取当前用户信息

### 积分系统
1. 积分操作必须使用事务
2. 消费前检查余额是否充足
3. 每笔交易记录 `balanceBefore` 和 `balanceAfter`
4. 目前未集成支付系统，充值为开发功能

---

## 文档维护

### 必须更新文档的情况
1. **新功能开发**: 更新 `markdown/todo.md`
2. **API 变更**: 更新 `markdown/api_doc_guide.md`
3. **问题解决**: 记录到 `markdown/question.md`
4. **配置变更**: 更新对应的配置文档

### 文档位置
- `README.md`: 项目总览
- `markdown/README.md`: 文档中心首页
- `markdown/api_doc_guide.md`: API 接口文档
- `markdown/API_RESPONSE_GUIDE.md`: API 响应格式
- `markdown/question.md`: 问题解决方案
- `markdown/todo.md`: 功能开发计划
- `markdown/DOCKER_DEPLOYMENT_GUIDE.md`: 部署教程
- `markdown/configuration-guide.md`: 配置指南
- `markdown/tailwind-guide.md`: Tailwind 使用指南

---

## AI 编程助手使用建议

### 代码生成
1. 生成的代码必须符合项目规范
2. 使用项目中已有的工具函数和组件
3. 遵循项目的目录结构和命名规范
4. 生成 API 接口时必须使用统一响应格式

### 代码审查
1. 检查是否符合 TypeScript 规范
2. 检查是否有安全隐患
3. 检查是否有性能问题
4. 检查错误处理是否完善

### 文档生成
1. 代码注释使用中文简体
2. 遵循 JSDoc 规范
3. API 文档包含完整的参数和响应示例

### 问题解决
1. 参考 `markdown/question.md` 中的已知问题
2. 参考项目文档中的相关章节
3. 遵循项目的调试和排查流程

---

## 相关文档链接

- 📖 [项目文档中心](./README.md)
- 🎯 [API 接口文档](./markdown/api_doc_guide.md)
- 📝 [API 响应格式指南](./markdown/API_RESPONSE_GUIDE.md)
- 🐛 [问题解决方案汇总](./markdown/question.md)
- 📋 [功能开发计划](./markdown/todo.md)
- 🚀 [Docker 部署教程](./markdown/DOCKER_DEPLOYMENT_GUIDE.md)
- 🎨 [Tailwind 使用指南](./markdown/tailwind-guide.md)
- ⚙️ [项目配置指南](./markdown/configuration-guide.md)

---

**最后更新**: 2026-02-02
**维护者**: AI睡眠空间开发团队

