# å¼‚æ­¥æ•…äº‹ç”ŸæˆåŠŸèƒ½å®æ–½æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜äº†æ•…äº‹å¼‚æ­¥ç”ŸæˆåŠŸèƒ½çš„å®æ–½ç»†èŠ‚ã€‚è¯¥åŠŸèƒ½è§£å†³äº† DeepSeek API è°ƒç”¨è€—æ—¶é•¿ï¼ˆ10-30ç§’ï¼‰å¯¼è‡´çš„ç”¨æˆ·ä½“éªŒé—®é¢˜ã€‚

### ä¼˜åŒ–å‰åå¯¹æ¯”

| æ–¹é¢ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| ç”¨æˆ·ç­‰å¾…æ—¶é—´ | 10-30ç§’ | < 1ç§’ |
| é¡µé¢å“åº” | é•¿æ—¶é—´ loading | ç«‹å³è·³è½¬ |
| å¤±è´¥é£é™© | ç”¨æˆ·å…³é—­é¡µé¢å¯¼è‡´ç§¯åˆ†æŸå¤± | åå°æ‰§è¡Œï¼Œå®‰å…¨å¯é  |
| ç”¨æˆ·ä½“éªŒ | ğŸ˜° ç„¦è™‘ç­‰å¾… | ğŸ˜Š æµç•…æ“ä½œ |

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»"ç”Ÿæˆæ•…äº‹"
      â†“
è¡¨å•éªŒè¯ + ç§¯åˆ†æ£€æŸ¥
      â†“
ä¿å­˜æ•…äº‹åŸºç¡€ä¿¡æ¯ï¼ˆçŠ¶æ€: pendingï¼‰
      â†“
æ‰£é™¤ç§¯åˆ†
      â†“
è§¦å‘åå°å¼‚æ­¥ç”Ÿæˆä»»åŠ¡ â† ä¸ç­‰å¾…è¿”å›
      â†“
ç«‹å³è·³è½¬åˆ°æ•…äº‹åˆ—è¡¨é¡µ
      â†“
ã€åå°ã€‘è°ƒç”¨ DeepSeek API
      â†“
ã€åå°ã€‘æ›´æ–°æ•…äº‹å†…å®¹ï¼ˆçŠ¶æ€: completedï¼‰
      â†“
ã€å‰ç«¯ã€‘è½®è¯¢åˆ·æ–°æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨

### 1. å‰ç«¯é¡µé¢
- âœ… `src/app/create-story/page.tsx` - åˆ›å»ºæ•…äº‹é¡µé¢
- âœ… `src/app/to-explore-story/components/StoryCard.tsx` - æ•…äº‹å¡ç‰‡ç»„ä»¶
- âœ… `src/app/to-explore-story/components/StoryListClient.tsx` - æ•…äº‹åˆ—è¡¨å®¢æˆ·ç«¯ç»„ä»¶

### 2. åç«¯ API
- âœ… `src/app/api/stories/generate-async/route.ts` - **æ–°å¢**å¼‚æ­¥ç”Ÿæˆ API

### 3. é…ç½®æ–‡ä»¶
- âœ… `env.production.example` - ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. æ•°æ®åº“è®¾è®¡ï¼ˆextData å­—æ®µï¼‰

Story æ¨¡å‹çš„ `extData` å­—æ®µï¼ˆJSON æ ¼å¼ï¼‰å¢åŠ ä»¥ä¸‹å­—æ®µï¼š

```typescript
{
  "wordRange": "200-500",                        // åŸæœ‰å­—æ®µ
  "generationStatus": "pending",                 // ç”ŸæˆçŠ¶æ€
  "generationStartedAt": "2026-01-06T10:00:00Z", // å¼€å§‹æ—¶é—´
  "generationCompletedAt": "2026-01-06T10:00:30Z", // å®Œæˆæ—¶é—´ï¼ˆå¯é€‰ï¼‰
  "generationError": null                        // é”™è¯¯ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
}
```

#### çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | å«ä¹‰ | æ˜¾ç¤º |
|------|------|------|
| `pending` | ç­‰å¾…ç”Ÿæˆ | ğŸŸ¡ ç”Ÿæˆä¸­ |
| `generating` | æ­£åœ¨ç”Ÿæˆ | ğŸŸ¡ ç”Ÿæˆä¸­ |
| `completed` | ç”Ÿæˆå®Œæˆ | âœ… æ­£å¸¸æ˜¾ç¤º |
| `failed` | ç”Ÿæˆå¤±è´¥ | âŒ ç”Ÿæˆå¤±è´¥ |

---

### 2. API æ¥å£

#### POST `/api/stories/generate-async`

è§¦å‘å¼‚æ­¥ç”Ÿæˆæ•…äº‹å†…å®¹ã€‚

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "storyId": 123,
  "formData": {
    "ageGroup": "3-5å²",
    "storySubjectType": "classic",
    "storySubject": "å†’é™©",
    "storyChildSubject": "æ£®æ—æ¢é™©",
    "characterSetting": "å°å…”å­æ³¢æ¯”...",
    "wordCountLimit": "200-500"
  }
}
```

**å“åº”ï¼ˆç«‹å³è¿”å› 202ï¼‰ï¼š**
```json
{
  "success": true,
  "message": "æ•…äº‹ç”Ÿæˆä»»åŠ¡å·²å¯åŠ¨",
  "data": {
    "storyId": 123
  }
}
```

---

### 3. å‰ç«¯å®ç°è¦ç‚¹

#### 3.1 åˆ›å»ºæ•…äº‹é¡µé¢ (`create-story/page.tsx`)

**å…³é”®æ”¹åŠ¨ï¼š**
```typescript
// 1. å‡†å¤‡æ•…äº‹æ•°æ®æ—¶ï¼Œè®¾ç½® pending çŠ¶æ€
const storyData = {
  // ... å…¶ä»–å­—æ®µ
  extData: JSON.stringify({
    wordRange: formData.wordCountLimit,
    generationStatus: 'pending',
    generationStartedAt: new Date().toISOString(),
  }),
};

// 2. è§¦å‘å¼‚æ­¥ä»»åŠ¡ï¼ˆä¸ç­‰å¾…ï¼‰
fetch('/api/stories/generate-async', {
  method: 'POST',
  body: JSON.stringify({ storyId: story.id, formData }),
}).catch(err => console.error('è§¦å‘ç”Ÿæˆä»»åŠ¡å¤±è´¥:', err));

// 3. ç«‹å³è·³è½¬
router.push('/to-explore-story');
```

#### 3.2 æ•…äº‹å¡ç‰‡ç»„ä»¶ (`StoryCard.tsx`)

**æ–°å¢åŠŸèƒ½ï¼š**
1. âœ… è§£æ `extData` è·å–ç”ŸæˆçŠ¶æ€
2. âœ… æ˜¾ç¤º"ç”Ÿæˆä¸­"åŠ¨ç”»æ ‡ç­¾
3. âœ… æ˜¾ç¤º"ç”Ÿæˆå¤±è´¥"é”™è¯¯æç¤º
4. âœ… æ­£åœ¨ç”Ÿæˆæ—¶æ˜¾ç¤ºå ä½ç¬¦

**è§†è§‰æ•ˆæœï¼š**
- ğŸŸ¡ ç”Ÿæˆä¸­ï¼šé»„è‰²æ ‡ç­¾ + è„‰å†²åŠ¨ç”»
- âŒ ç”Ÿæˆå¤±è´¥ï¼šçº¢è‰²æ ‡ç­¾ + é”™è¯¯ä¿¡æ¯
- â³ AI æ­£åœ¨åˆ›ä½œï¼šä¸‰ä¸ªè·³åŠ¨çš„ç‚¹

#### 3.3 æ•…äº‹åˆ—è¡¨å®¢æˆ·ç«¯ (`StoryListClient.tsx`)

**æ–°å¢åŠŸèƒ½ï¼š**
1. âœ… æ£€æµ‹æ­£åœ¨ç”Ÿæˆçš„æ•…äº‹
2. âœ… è‡ªåŠ¨è½®è¯¢åˆ·æ–°ï¼ˆæ¯ 5 ç§’ï¼‰
3. âœ… æ‰€æœ‰æ•…äº‹å®Œæˆååœæ­¢è½®è¯¢

**è½®è¯¢é€»è¾‘ï¼š**
```typescript
useEffect(() => {
  if (!hasGeneratingStories()) return;

  const interval = setInterval(() => {
    refreshGeneratingStories(); // åˆ·æ–°æ­£åœ¨ç”Ÿæˆçš„æ•…äº‹
  }, 5000);

  return () => clearInterval(interval);
}, [stories]);
```

---

### 4. åç«¯å®ç°è¦ç‚¹

#### 4.1 å¼‚æ­¥ç”Ÿæˆå¤„ç†

**æ ¸å¿ƒå‡½æ•°ï¼š** `generateStoryInBackground()`

```typescript
async function generateStoryInBackground(storyId, formData) {
  try {
    // 1. æ›´æ–°çŠ¶æ€ä¸º generating
    await updateStoryStatus(storyId, 'generating');

    // 2. ç”Ÿæˆ prompt
    const prompt = generatePrompt(formData);

    // 3. è°ƒç”¨ DeepSeek APIï¼ˆå¸¦é‡è¯•ï¼‰
    const content = await callAIWithRetry(prompt, 3);

    // 4. æ›´æ–°æ•…äº‹å†…å®¹å’ŒçŠ¶æ€
    await prisma.story.update({
      where: { id: storyId },
      data: {
        content: content,
        extData: JSON.stringify({
          generationStatus: 'completed',
          generationCompletedAt: new Date().toISOString(),
        }),
      },
    });
  } catch (error) {
    // 5. å¤±è´¥å¤„ç†
    await updateStoryStatus(storyId, 'failed', error.message);
  }
}
```

#### 4.2 é”™è¯¯å¤„ç†ä¸é‡è¯•

**é‡è¯•ç­–ç•¥ï¼š**
- æœ€å¤šé‡è¯• 3 æ¬¡
- æŒ‡æ•°é€€é¿ï¼š2ç§’ â†’ 4ç§’ â†’ 8ç§’
- è¶…æ—¶æ—¶é—´ï¼š60 ç§’

```typescript
async function callAIWithRetry(prompt, maxRetries = 3) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await callDeepSeekAPI(prompt);
    } catch (error) {
      if (attempt < maxRetries) {
        const delay = Math.pow(2, attempt) * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }
  throw new Error('API è°ƒç”¨å¤±è´¥');
}
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env.production` æˆ– `.env.local` ä¸­æ·»åŠ ï¼š

```bash
# DeepSeek API é…ç½®
DEEPSEEK_API_KEY=sk-your-api-key-here
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-chat
```

### 2. æ•°æ®åº“è¿ç§»

æ•°æ®åº“ç»“æ„æ— éœ€ä¿®æ”¹ï¼Œ`extData` å­—æ®µå·²å­˜åœ¨ã€‚ç°æœ‰æ•…äº‹ä¼šè‡ªåŠ¨å…¼å®¹ï¼ˆé»˜è®¤ä¸º `completed` çŠ¶æ€ï¼‰ã€‚

### 3. ä»£ç éƒ¨ç½²

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœ‰æ›´æ–°ï¼‰
pnpm install

# 3. æ„å»ºé¡¹ç›®
pnpm build

# 4. é‡å¯æœåŠ¡
pm2 restart ltbot-nextapp
# æˆ– Docker é‡å¯
docker-compose up -d --build
```

### 4. éªŒè¯åŠŸèƒ½

#### æµ‹è¯•æµç¨‹ï¼š
1. âœ… ç™»å½•ç³»ç»Ÿï¼Œè¿›å…¥åˆ›å»ºæ•…äº‹é¡µé¢
2. âœ… å¡«å†™è¡¨å•ï¼Œç‚¹å‡»"ç”Ÿæˆæ•…äº‹"
3. âœ… éªŒè¯æ˜¯å¦ç«‹å³è·³è½¬åˆ°åˆ—è¡¨é¡µï¼ˆ< 1ç§’ï¼‰
4. âœ… éªŒè¯æ•…äº‹å¡ç‰‡æ˜¾ç¤º"ç”Ÿæˆä¸­"æ ‡ç­¾
5. âœ… ç­‰å¾… 10-30 ç§’ï¼ŒéªŒè¯è‡ªåŠ¨åˆ·æ–°
6. âœ… éªŒè¯æ•…äº‹å†…å®¹æ˜¯å¦æ­£å¸¸æ˜¾ç¤º

---

## ğŸ¨ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### è§†è§‰åé¦ˆ

| çŠ¶æ€ | æ ‡ç­¾æ ·å¼ | å†…å®¹åŒºåŸŸ |
|------|----------|----------|
| ç”Ÿæˆä¸­ | ğŸŸ¡ é»„è‰²è„‰å†² + "ç”Ÿæˆä¸­" | â³ ä¸‰ä¸ªè·³åŠ¨çš„ç‚¹ + "AI æ­£åœ¨åˆ›ä½œæ•…äº‹ä¸­..." |
| ç”Ÿæˆå¤±è´¥ | ğŸ”´ çº¢è‰² + "ç”Ÿæˆå¤±è´¥" | ğŸ˜” "æ•…äº‹ç”Ÿæˆå¤±è´¥" + é”™è¯¯ä¿¡æ¯ |
| å·²å®Œæˆ | âœ… æ— ç‰¹æ®Šæ ‡ç­¾ | ğŸ“ æ­£å¸¸æ˜¾ç¤ºæ•…äº‹å†…å®¹ |

### åŠ¨ç”»æ•ˆæœ

- **è„‰å†²åŠ¨ç”»**ï¼šæ ‡ç­¾å‘¼å¸æ•ˆæœ
- **è·³åŠ¨ç‚¹**ï¼šä¸‰ä¸ªç‚¹ä¾æ¬¡è·³åŠ¨
- **è‡ªåŠ¨åˆ·æ–°**ï¼šæ— æ„ŸçŸ¥æ›´æ–°

---

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—è¾“å‡º

åç«¯ä¼šè¾“å‡ºè¯¦ç»†çš„ç”Ÿæˆæ—¥å¿—ï¼š

```
[Story 123] å¼€å§‹ç”Ÿæˆæ•…äº‹å†…å®¹...
[Story 123] ç”Ÿæˆçš„ prompt: ...
å°è¯•è°ƒç”¨ DeepSeek API (ç¬¬ 1/3 æ¬¡)...
[Story 123] æ•…äº‹å†…å®¹ç”ŸæˆæˆåŠŸï¼Œé•¿åº¦: 456
[Story 123] çŠ¶æ€å·²æ›´æ–°ä¸º: completed
[Story 123] æ•…äº‹ç”Ÿæˆå®Œæˆï¼
```

### é”™è¯¯ç›‘æ§

å¤±è´¥æƒ…å†µä¼šè®°å½•åˆ° `extData.generationError`ï¼š
- API è°ƒç”¨å¤±è´¥
- è¶…æ—¶é”™è¯¯
- ç½‘ç»œé”™è¯¯

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. API å¯†é’¥å®‰å…¨
- âœ… API å¯†é’¥å­˜å‚¨åœ¨æœåŠ¡ç«¯ç¯å¢ƒå˜é‡
- âœ… å‰ç«¯ä»£ç ä¸­å·²ç§»é™¤ API é…ç½®
- âŒ ä¸è¦å°†å¯†é’¥æäº¤åˆ° Git

### 2. å¹¶å‘æ§åˆ¶
- å½“å‰ç‰ˆæœ¬ï¼šæ— å¹¶å‘é™åˆ¶
- å»ºè®®ï¼šä¸šåŠ¡é‡å¢é•¿åæ·»åŠ é˜Ÿåˆ—é™æµ

### 3. ç§¯åˆ†å¤„ç†
- å½“å‰ï¼šåˆ›å»ºæ•…äº‹åç«‹å³æ‰£é™¤ç§¯åˆ†
- æœªæ¥ä¼˜åŒ–ï¼šç”ŸæˆæˆåŠŸåå†æ‰£é™¤

### 4. é”™è¯¯æ¢å¤
- ç”¨æˆ·å¯åˆ·æ–°é¡µé¢æŸ¥çœ‹æœ€æ–°çŠ¶æ€
- å¤±è´¥çš„æ•…äº‹å¯æ·»åŠ "é‡è¯•"æŒ‰é’®ï¼ˆå¾…å®ç°ï¼‰

---

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

### ç¬¬ä¸€é˜¶æ®µï¼ˆå·²å®Œæˆï¼‰âœ…
- [x] åŸºç¡€å¼‚æ­¥ç”Ÿæˆ
- [x] çŠ¶æ€è½®è¯¢
- [x] è§†è§‰åé¦ˆ

### ç¬¬äºŒé˜¶æ®µï¼ˆæ¨èï¼‰
- [ ] Server-Sent Events (SSE) å®æ—¶æ¨é€
- [ ] å¤±è´¥æ•…äº‹é‡è¯•æŒ‰é’®
- [ ] ç”Ÿæˆè¿›åº¦æ˜¾ç¤ºï¼ˆ0%-100%ï¼‰

### ç¬¬ä¸‰é˜¶æ®µï¼ˆç”Ÿäº§ä¼˜åŒ–ï¼‰
- [ ] å¼•å…¥ Redis + BullMQ æ¶ˆæ¯é˜Ÿåˆ—
- [ ] ä»»åŠ¡æŒä¹…åŒ–ï¼ˆæœåŠ¡é‡å¯ä¸ä¸¢å¤±ï¼‰
- [ ] ä»»åŠ¡ç›‘æ§é¢æ¿
- [ ] é‚®ä»¶/ç«™å†…ä¿¡é€šçŸ¥

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: æœåŠ¡é‡å¯åæ­£åœ¨ç”Ÿæˆçš„æ•…äº‹ä¼šæ€æ ·ï¼Ÿ
A: å½“å‰ç‰ˆæœ¬ä¼šä¸¢å¤±ï¼ŒçŠ¶æ€åœç•™åœ¨ `generating`ã€‚å¯æ‰‹åŠ¨æ›´æ–°çŠ¶æ€æˆ–ç­‰å¾…æœªæ¥é˜Ÿåˆ—æ–¹æ¡ˆã€‚

### Q2: å¦‚ä½•æ‰‹åŠ¨è§¦å‘é‡æ–°ç”Ÿæˆï¼Ÿ
A: æš‚æ— å‰ç«¯å…¥å£ï¼Œå¯é€šè¿‡ API æ‰‹åŠ¨è°ƒç”¨ï¼š
```bash
curl -X POST http://localhost:3100/api/stories/generate-async \
  -H "Content-Type: application/json" \
  -d '{"storyId": 123, "formData": {...}}'
```

### Q3: è½®è¯¢ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ
A: å½±å“å¾ˆå°ã€‚ä»…å½“æœ‰æ­£åœ¨ç”Ÿæˆçš„æ•…äº‹æ—¶æ‰è½®è¯¢ï¼Œä¸”ä»…æŸ¥è¯¢ç‰¹å®šæ•…äº‹ï¼Œä¸ä¼šå…¨é‡æŸ¥è¯¢ã€‚

### Q4: å¦‚ä½•è°ƒæ•´è½®è¯¢é¢‘ç‡ï¼Ÿ
A: ä¿®æ”¹ `StoryListClient.tsx` ä¸­çš„é—´éš”æ—¶é—´ï¼š
```typescript
const interval = setInterval(() => {
  refreshGeneratingStories();
}, 5000); // æ”¹ä¸ºå…¶ä»–å€¼ï¼Œå¦‚ 3000 (3ç§’) æˆ– 10000 (10ç§’)
```

---

## ğŸ“§ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- æŠ€æœ¯è´Ÿè´£äººï¼š[æ‚¨çš„åå­—]
- é‚®ç®±ï¼š[æ‚¨çš„é‚®ç®±]

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [API æ–‡æ¡£](./API_DOCUMENTATION.md)
- [Docker éƒ¨ç½²æŒ‡å—](./DOCKER_DEPLOYMENT_GUIDE.md)
- [é…ç½®æŒ‡å—](./configuration-guide.md)

---

**æœ€åæ›´æ–°æ—¶é—´ï¼š** 2026-01-06  
**ç‰ˆæœ¬ï¼š** v1.0.0  
**å®æ–½çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ

